<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LubeLogger Camera</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
	<style>
		.mainContainer {
			width: 100dvw;
			height: 100dvh;
		}
		.camera-container {
			height:100%;
			width:100%;
			overflow:auto;
		}
		.camera-container video{
			max-height: 100%;
			max-width: 100%;
		}
		.video-overlay{
			background-image: url("test_image.png");
			background-size:contain;
			opacity: 0.5;
			width: 100%;
			height: 100%;
		}
		.video-overlay-container{
			position: absolute;
		}
	</style>
</head>
<body>
<main>
<div class="d-flex flex-column mainContainer">
<div class="flex-grow-1" style="overflow:auto;">
<div class="camera-container d-flex justify-content-center align-items-center">
	<video id="video" autoplay playsinline></video>
</div>
</div>
<div class="d-flex justify-content-center">
<button class='btn-lg btn btn-outline-primary' onclick="captureAndDownload()"><i class="bi bi-record-fill"></i></button>
</div>
<div id="videoOverlayContainer" class="video-overlay-container d-flex justify-content-center align-items-center">
	<div class="video-overlay"></div>
</div>
</div>
<a id="download-link" style="display:none;"></a>
<canvas id="canvas" style="display:none;"></canvas>
</main>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
<script>
let stream = null;
const video = document.getElementById('video');
const videoOverlay = document.getElementById('videoOverlayContainer');
const canvas = document.getElementById('canvas');
const context = canvas.getContext('2d');
const downloadLink = document.getElementById('download-link');
function showVideoOverlay(){
	videoOverlay.style.top = `${video.offsetTop}px`;
	videoOverlay.style.left = `${video.offsetLeft}px`;
	videoOverlay.style.width = `${video.offsetWidth}px`;
	videoOverlay.style.height = `${video.offsetHeight}px`;
}
async function startCamera(){
	if (stream){
		stopCamera();
		return;
	}
	let constraints = {
                    video: {
                        facingMode: { exact: 'environment' }, // Rear camera
                        aspectRatio: { ideal: 4/3 },
                        width: { ideal: 1280 },
                        height: { ideal: 960 }
                    },
                    audio: false
                };
	let fallBackConstraints = {
					video: {
                        facingMode: 'environment', // Rear camera
                        aspectRatio: { ideal: 4/3 }
                    },
                    audio: false
	};
	try {
		stream = await navigator.mediaDevices.getUserMedia(constraints);
		video.srcObject = stream;
	} catch (error) {
		console.log(error);
		try {
			stream = await navigator.mediaDevices.getUserMedia(fallBackConstraints);
			video.srcObject = stream;
		} catch (fallBackError) {
			console.log(fallBackError);
		}
	}
}
function captureAndDownload(){
	canvas.width = video.videoWidth;
	canvas.height = video.videoHeight;
	// Draw the current video frame onto the canvas
	context.drawImage(video, 0, 0, canvas.width, canvas.height);
		
	// 3. Create a downloadable link
	canvas.toBlob((blob) => {
		const objectUrl = URL.createObjectURL(blob);
		downloadLink.href = objectUrl;
		downloadLink.download = 'webcam-photo.png'; // Set the download file name
		downloadLink.click(); // Make the link visible
	}, 'image/png');
}
const portraitMedia = window.matchMedia("(orientation: portrait)");
portraitMedia.addEventListener("change", () => {
	console.log('change');
	if (videoOverlay.offsetWidth != 0){
		showVideoOverlay();
	}
});
const resizeObserver = new ResizeObserver(() => {
    showVideoOverlay();
});
resizeObserver.observe(video);
startCamera();
</script>
</html>